using System;
using System.Data;
using System.Windows.Forms;
using Npgsql;

namespace WindowsFormsApp1
{
    public partial class Chat : Form
    {
        private string currentUserId; // 로그인한 사용자 ID
        private NpgsqlConnection nConnect; // 데이터베이스 연결 객체

        public Chat(string id)
        {
            InitializeComponent();
            currentUserId = id;
            InitializeConnection();
            LoadUsers();
            lbUser.SelectedIndexChanged += lbUser_SelectedIndexChanged; // 사용자 선택 시 이벤트 핸들러 연결
        }

        private void InitializeConnection()
        {
            try
            {
                string connectionString = "Server=localhost;Port=5432;User Id=postgres;Password=5130;Database=NeighborChat;";
                nConnect = new NpgsqlConnection(connectionString);
                nConnect.Open(); // 데이터베이스 연결 열기
            }
            catch (Exception ex)
            {
                MessageBox.Show($"데이터베이스 연결 오류: {ex.Message}", "오류", MessageBoxButtons.OK, MessageBoxIcon.Error);
                this.Close(); // 오류 발생 시 폼 닫기
            }
        }

        private void LoadUsers()
        {
            try
            {
                string query = "SELECT id FROM signup";
                lbUser.Items.Clear(); // 리스트박스 초기화

                using (var command = new NpgsqlCommand(query, nConnect))
                {
                    using (var reader = command.ExecuteReader())
                    {
                        while (reader.Read())
                        {
                            string userId = reader.GetString(0);
                            if (userId != currentUserId) // 자신을 제외한 사용자만 추가
                            {
                                lbUser.Items.Add(userId); // 사용자 ID를 리스트박스에 추가
                            }
                        }
                    }
                }
            }
            catch (Exception ex)
            {
                MessageBox.Show($"사용자 목록 로드 오류: {ex.Message}", "오류", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }

        private void lbUser_SelectedIndexChanged(object sender, EventArgs e)
        {
            string selectedUserId = lbUser.SelectedItem?.ToString();

            if (!string.IsNullOrEmpty(selectedUserId))
            {
                // 선택한 사용자와의 채팅 폼을 새로 열기
                var chatForm = new ChatForm(currentUserId, selectedUserId);
                chatForm.Show();
            }
        }
    }
}
